---
title: iOSå•ä¾‹æ¨¡å¼
date: 2016-03-12 12:36:23
tags: iOS
grammar_cjkRuby: true
---

### å•ä¾‹æ¨¡å¼

**å•ä¾‹æ¨¡å¼ï¼ˆSingletonï¼‰ä½œç”¨**ï¼š

- å¯ä»¥ä¿è¯çš„ç¨‹åºè¿è¡Œè¿‡ç¨‹ï¼Œä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªç¤ºä¾‹,å¹¶æä¾›ä¸€ä¸ªè®¿é—®å®ƒçš„å…¨å±€è®¿é—®ç‚¹æ–¹ä¾¿å¤–ç•Œè®¿é—®
- æ§åˆ¶äº†å®ä¾‹ä¸ªæ•°ï¼Œå¹¶èŠ‚çº¦ç³»ç»Ÿèµ„æºã€‚

â€‹    å•ä¾‹å†™æ³•æœ‰å¥½å‡ ç§ï¼Œé€šå¸¸çš„å†™æ³•æ˜¯åŸºäºçº¿ç¨‹å®‰å…¨çš„å†™æ³•ï¼Œä¿è¯å•ä¾‹å¯¹è±¡åªä¼šè¢«åˆ›å»ºä¸€æ¬¡ï¼Œä¸ºå•ä¾‹å¯¹è±¡åˆ›å»ºä¸€ä¸ªé™æ€å®ä¾‹ï¼Œå¯ä»¥å†™æˆå…¨å±€çš„ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»æ–¹æ³•ä¸­å®ç°ï¼Œå¹¶ç½®ä¸ºnilã€‚

##### ç®€è¦æ­¥éª¤

- 1ã€å…ˆå®šä¹‰ä¸€ä¸ªé™æ€çš„instance.
- 2ã€å®šä¸€ä¸ªsharedInstanceçš„ç±»æ–¹æ³•.èƒ½å¤Ÿè¢«å…¨å±€è°ƒç”¨çš„.æ­¤æ–¹æ³•é‡Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜
- 3ã€å¦‚æœéœ€è¦copy,éœ€è¦éµå®ˆNSCopyingåè®®,ä»¥åŠåœ¨copyWithZoneä¸­,ç›´æ¥è¿”å›self;

åˆ›å»ºä¸€ä¸ªç»§æ‰¿ç»§æ‰¿è‡ªNSObjectçš„ç±»AccountManager

`AccountManager.h`æ–‡ä»¶

```objectivec
//
//  AccountManager.h
//  Copyright Â© 2018å¹´ hl.com.cn. All rights reserved.
//

#import <Foundation/Foundation.h>

@interface AccountManager : NSObject

/**å¿«é€Ÿåˆ›å»ºå•ä¾‹çš„ç±»æ–¹æ³•*/
+ (instancetype)sharedInstance;

@end
```

`AccountManager.m`æ–‡ä»¶ï¼ˆç®€æ´ç‰ˆï¼Œä¸è€ƒè™‘`alloc`,`copy`æ–¹å¼åˆ›å»ºå•ä¾‹ï¼‰

```objectivec
//
//  AccountManager.m
//  Copyright Â© 2018å¹´ hl.com.cn. All rights reserved.
//

#import "AccountManager.h"

@implementation AccountManager

//ä¸ºå•ä¾‹å¯¹è±¡åˆ›å»ºçš„é™æ€å®ä¾‹ï¼Œå› ä¸ºå¯¹è±¡çš„å”¯ä¸€æ€§ï¼Œå¿…é¡»æ˜¯staticç±»å‹
static AccountManager *_sharedInstance = nil;

#pragma mark---åˆ›å»ºå•ä¾‹(æ™®é€šï¼ŒåŒæ­¥é”ï¼ŒGCDä¸‰ç§æ–¹å¼)
/**
 * æœ€ç®€å•çš„å•ä¾‹(ä¸å»ºè®®ä½¿ç”¨)
 * ç¼ºç‚¹ï¼šæ²¡æœ‰è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰
 */
+ (instancetype)sharedInstance1{
    if (!_sharedInstance) {
        _sharedInstance = [[self alloc]init];
    }
    return _sharedInstance;
}


/**
 *åŒæ­¥é”ç‰ˆæœ¬
 *ä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨
 *ç¼ºç‚¹ï¼šæ¯æ¬¡è¿è¡Œä»£ç å‰éƒ½è¦è·å–é”ï¼Œæ•ˆç‡è¾ƒGCDæ…¢
 */
+ (instancetype)sharedInstance{
    //è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜, æ‰€ä»¥åŠ ä¸ª@synchronizedåŒæ­¥é”
    @synchronized(self) {
        if (!_sharedInstance) {
            _sharedInstance = [[self alloc] init];

        }
    }
    return _sharedInstance;
}

/**
 *GCDç‰ˆæœ¬ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰--ğŸæ¨è
 *ä¼˜ç‚¹ï¼š1ã€çº¿ç¨‹å®‰å…¨ 2ã€æ— éœ€æ‹…å¿ƒåŠ é”æˆ–åŒæ­¥
 *ç¼ºç‚¹ï¼šæš‚æ— 
 */
static dispatch_once_t onceToken;/*è¿™ä¸ªæ‹¿åˆ°å‡½æ•°ä½“å¤–,æˆä¸ºå…¨å±€çš„,ç”¨äºè®¿é—®é”€æ¯å•ä¾‹*/
+ (instancetype)sharedInstance2 {
    //dispatch_onceä¿è¯çº¿ç¨‹å®‰å…¨
    dispatch_once(&onceToken, ^{
        _sharedInstance = [[self alloc] init];
    });
    return _sharedInstance;
}


#pragma mark---é”€æ¯å•ä¾‹
/**
 * åŒæ­¥é”ç‰ˆæœ¬:é”€æ¯å•ä¾‹
 */
+(void)attemptDealloc{
    _sharedInstance = nil;
}


/**
 * GCDç‰ˆæœ¬:é”€æ¯å•ä¾‹
 */
+(void)attempDealloc{
     onceToken = 0; // åªæœ‰ç½®æˆ0,GCDæ‰ä¼šè®¤ä¸ºå®ƒä»æœªæ‰§è¡Œè¿‡.å®ƒé»˜è®¤ä¸º0.è¿™æ ·æ‰èƒ½ä¿è¯ä¸‹æ¬¡å†æ¬¡è°ƒç”¨shareInstanceçš„æ—¶å€™,å†æ¬¡åˆ›å»ºå¯¹è±¡.
    _sharedInstance = nil;
}
```

è¿™æ ·å°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„å•ä¾‹,ä¿è¯æ€ä¹ˆåˆ›å»ºéƒ½æ˜¯å”¯ä¸€çš„.

æµ‹è¯•å•ä¾‹

```objectivec
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view, typically from a nib.
    AccountManager *obj1 = [AccountManager sharedInstance] ;
    NSLog(@"obj1 = %@", obj1) ;

    AccountManager *obj2 = [AccountManager sharedInstance] ;
    NSLog(@"obj2 = %@", obj2) ;

    AccountManager *obj3 = [[AccountManager alloc] init] ;
    NSLog(@"obj3 = %@", obj3) ;

    AccountManager* obj4 = [[AccountManager alloc] init] ;
    NSLog(@"obj4 = %@", [obj4 copy]) ;
}
```

æ‰“å°è¯¦æƒ…

```shell
2016-03-12 14:30:52.078030+0800 SingletonDemo[3438:763080] obj1 = <AccountManager: 0x60400001dfb0>
2016-03-12 14:30:52.078208+0800 SingletonDemo[3438:763080] obj2 = <AccountManager: 0x60400001dfb0>
2016-03-12 14:30:52.078340+0800 SingletonDemo[3438:763080] obj3 = <AccountManager: 0x60000001e230>
2016-03-12 14:30:52.078340+0800 SingletonDemo[3438:763080] obj4 ç›´æ¥Crash
```

â€‹	ä»¥ä¸Šåˆ›å»ºå•ä¾‹æ–¹å¼åŸºæœ¬å¯ä»¥äº†ï¼Œé€šè¿‡`alloc`ï¼Œ`copy`æ–¹å¼åˆ›å»ºå•ä¾‹æœ¬èº«å°±æ˜¯ä¸€ç§éè§„èŒƒå†™æ³•ï¼Œä½†ä¸ºäº†æé«˜å®¹é”™ç‡ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¤„ç†ä¸‹`alloc`ï¼Œ`copy`æ–¹å¼åˆ›å»ºå•ä¾‹ã€‚

å‡çº§ç‰ˆ

```objectivec
//
//  AccountManager.m
//  Copyright Â© 2018å¹´ hl.com.cn. All rights reserved.
//

#import "AccountManager.h"

@implementation AccountManager

//ä¸ºå•ä¾‹å¯¹è±¡åˆ›å»ºçš„é™æ€å®ä¾‹ï¼Œå› ä¸ºå¯¹è±¡çš„å”¯ä¸€æ€§ï¼Œå¿…é¡»æ˜¯staticç±»å‹
static AccountManager *_sharedInstance = nil;

/**
 * æœ€ç®€å•çš„å•ä¾‹
 * ç¼ºç‚¹ï¼šæ²¡æœ‰è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼ˆéçº¿ç¨‹å®‰å…¨ï¼‰
 */
+ (instancetype)sharedInstance1{
    if (!_sharedInstance) {
        _sharedInstance = [[self alloc]init];
    }
    return _sharedInstance;
}


/**
 *åŒæ­¥é”ç‰ˆæœ¬
 *ä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨
 *ç¼ºç‚¹ï¼šæ¯æ¬¡è¿è¡Œä»£ç å‰éƒ½è¦è·å–é”ï¼Œæ•ˆç‡è¾ƒGCDæ…¢
 */
+ (instancetype)sharedInstance{
    //è€ƒè™‘å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜, æ‰€ä»¥åŠ ä¸ª@synchronizedåŒæ­¥é”
    @synchronized(self) {
        if (!_sharedInstance) {
            _sharedInstance = [[super allocWithZone:NULL] init];
        }
    }
    return _sharedInstance;
}

/**
 *GCDç‰ˆæœ¬ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰--ğŸæ¨è
 *ä¼˜ç‚¹ï¼š1ã€çº¿ç¨‹å®‰å…¨ 2ã€æ— éœ€æ‹…å¿ƒåŠ é”æˆ–åŒæ­¥
 *ç¼ºç‚¹ï¼šæš‚æ— 
 */
static dispatch_once_t onceToken;/*è¿™ä¸ªæ‹¿åˆ°å‡½æ•°ä½“å¤–,æˆä¸ºå…¨å±€çš„,ç”¨äºè®¿é—®é”€æ¯å•ä¾‹*/
+ (instancetype)sharedInstance2 {
    //dispatch_onceä¿è¯çº¿ç¨‹å®‰å…¨
    dispatch_once(&onceToken, ^{
        _sharedInstance = [[self alloc] init];
    });
    return _sharedInstance;
}


#pragma mark---é”€æ¯å•ä¾‹
/**
 åŒæ­¥é”ç‰ˆæœ¬:é”€æ¯å•ä¾‹
 */
+(void)attemptDealloc1{
    _sharedInstance = nil;
}


/**
 GCDç‰ˆæœ¬:é”€æ¯å•ä¾‹
 */
+(void)attempDealloc2{
     onceToken = 0; // åªæœ‰ç½®æˆ0,GCDæ‰ä¼šè®¤ä¸ºå®ƒä»æœªæ‰§è¡Œè¿‡.å®ƒé»˜è®¤ä¸º0.è¿™æ ·æ‰èƒ½ä¿è¯ä¸‹æ¬¡å†æ¬¡è°ƒç”¨shareInstanceçš„æ—¶å€™,å†æ¬¡åˆ›å»ºå¯¹è±¡.
    _sharedInstance = nil;
}



#pragma mark---å®Œå–„allocï¼Œcopyæ–¹å¼åˆ›å»ºçš„å•ä¾‹
/**
 *åˆ›å»ºå¯¹è±¡çš„æ­¥éª¤åˆ†ä¸ºç”³è¯·å†…å­˜(alloc)->åˆå§‹åŒ–(init)è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬è¦ç¡®ä¿å¯¹è±¡çš„å”¯ä¸€æ€§ï¼Œå› æ­¤åœ¨ç¬¬ä¸€æ­¥è¿™ä¸ªé˜¶æ®µæˆ‘ä»¬å°±è¦æ‹¦æˆªå®ƒã€‚å½“æˆ‘ä»¬è°ƒç”¨allocæ–¹æ³•æ—¶ï¼ŒOCå†…éƒ¨ä¼šè°ƒç”¨allocWithZoneè¿™ä¸ªæ–¹æ³•æ¥ç”³è¯·å†…å­˜ï¼Œæˆ‘ä»¬é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œç„¶ååœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨shareInstanceæ–¹æ³•è¿”å›å•ä¾‹å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚æ‹·è´å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„åŸç†ï¼Œé‡å†™copyWithZoneæ–¹æ³•ï¼Œç„¶ååœ¨è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨shareInstanceæ–¹æ³•è¿”å›å•ä¾‹å¯¹è±¡ã€‚
 * é‡å†™allocWithZoneæ–¹æ³•ï¼Œä¿è¯allocæˆ–è€…initåˆ›å»ºçš„å®ä¾‹ä¸ä¼šäº§ç”Ÿæ–°å®ä¾‹ï¼Œå› ä¸ºè¯¥ç±»è¦†ç›–äº†allocWithZoneæ–¹æ³•ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡å…¶çˆ¶ç±»åˆ†é…å†…å­˜ï¼Œå³[super allocWithZone]
 *    AccountManager *account= [AccountManager alloc]init];
 *
 */
+ (instancetype)allocWithZone:(struct _NSZone *)zone {
    return [self sharedInstance];// ç›´æ¥è°ƒç”¨å•ä¾‹çš„åˆ›å»ºæ–¹æ³•
}

/**
 *  NSCopyingåè®®,é‡å†™copyWithZoneæ–¹æ³•ï¼Œä¿è¯copyä¸ä¼šäº§ç”Ÿæ–°å®ä¾‹ï¼Œ
 *   ä¿è¯copyæ—¶ç›¸åŒ é˜²æ­¢AccountManager *account= [AccountManager copy];æ–¹å¼å‡ºç°Crash
 */
+ (id)copyWithZone:(struct _NSZone *)zone {
    return [self sharedInstance];
}
//

// é‡å†™copyæ–¹æ³•
- (id)copy {
    return self;
}

// é‡å†™ mutableCopy æ–¹æ³•
- (id)mutableCopy {
    return self;
}

@end
```

æµ‹è¯•æ‰“å°ä¿¡æ¯ï¼š

```shell
2016-03-12 14:53:17.572240+0800 SingletonDemo[3995:849854] obj1 = <AccountManager: 0x600000007850>
2016-03-12 14:53:17.572624+0800 SingletonDemo[3995:849854] obj2 = <AccountManager: 0x600000007850>
2016-03-12 14:53:17.572768+0800 SingletonDemo[3995:849854] obj3 = <AccountManager: 0x600000007850>
2016-03-12 14:53:17.572909+0800 SingletonDemo[3995:849854] obj4 = <AccountManager: 0x600000007850>
```

